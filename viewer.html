<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ruta del Camión</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
    }
    #map {
      position: absolute;
      top: 0; bottom: 0; right: 0; left: 320px;
    }
    #panel {
      position: absolute;
      top: 0; left: 0;
      width: 320px;
      bottom: 0;
      overflow-y: auto;
      background: #fff;
      padding: 12px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.2);
      z-index: 10;
    }
    .cliente {
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>

<body>
  <div id="panel"><em>Cargando clientes...</em></div>
  <div id="map"></div>

  <script>
    async function init() {
      const params = new URLSearchParams(window.location.search);
      const bk = params.get("bk") || "BK4802";

      const geo = await fetch(`public/${bk}.geojson`).then(r => r.json());
      const sorted = geo.features.slice().sort((a,b)=>a.properties.seq - b.properties.seq);
      const coords = sorted.map(f => ({ lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0] }));

      // Cargar mapa centrado en el primer punto
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 14,
        center: coords[0],
        mapId: "DEMO_MAP_ID" // opcional
      });

      // Marcadores
      sorted.forEach((f,i)=>{
        new google.maps.Marker({
          position: { lat: f.geometry.coordinates[1], lng: f.geometry.coordinates[0] },
          map,
          label: `${i+1}`
        });
      });

      // Directions
      const directionsService = new google.maps.DirectionsService();
      const directionsRenderer = new google.maps.DirectionsRenderer({
        map,
        suppressMarkers: true,
        polylineOptions: { strokeColor: "#007AFF", strokeWeight: 5 }
      });

      const result = await directionsService.route({
        origin: coords[0],
        destination: coords[coords.length - 1],
        waypoints: coords.slice(1, -1).map(c => ({ location: c })),
        travelMode: google.maps.TravelMode.DRIVING,
        optimizeWaypoints: false  // porque tú ya defines el orden
      });

      directionsRenderer.setDirections(result);

      // Panel de clientes
      document.getElementById("panel").innerHTML =
        `<h3>Clientes ${bk}</h3>` +
        sorted.map((p, i) => `<div class="cliente"><b>${i+1}.</b> ${p.properties.cliente}</div>`).join("");
    }
  </script>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkDF9OBntDCALLQsi4McjampEMebMBQkc&callback=init" async defer></script>
</body>
</html>
