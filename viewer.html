<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Rutas BK</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, Arial, sans-serif;
      background: #dfd2f4;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      max-width: 280px;
      max-height: 85%;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      padding: 14px;
      border-radius: 10px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.25);
      font-size: 14px;
    }
    #panel h3 {
      margin-top: 0;
      font-size: 15px;
      margin-bottom: 10px;
    }
    .cliente-item {
      padding: 4px 0;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="panel"><em>Cargando ruta...</em></div>

<script>

  // ⚠ Usa aquí tu token público (visible) solo para estilos.
  mapboxgl.accessToken = "pk.XXXXXXXXXXXXXXXXXXXXXXXXX";

  async function loadRouteAndDraw() {

    const params = new URLSearchParams(window.location.search);
    const bk = params.get("bk") || "BK4802";

    const panel = document.getElementById("panel");

    // 1) Cargar el GeoJSON
    let geo;
    try {
      geo = await fetch(`public/${bk}.geojson`).then(r => r.json());
    } catch (err) {
      panel.innerHTML = "<b>Error:</b> No se encontró el archivo GeoJSON.";
      return;
    }

    // 2) Ordenar puntos por secuencia
    const puntos = geo.features
      .filter(f => f.geometry.type === "Point")
      .sort((a, b) => a.properties.seq - b.properties.seq);

    // 3) Extraer coordenadas ordenadas
    const coords = puntos.map(f => f.geometry.coordinates);

    // 4) Construir línea simple (sin API Directions)
    const routeLine = {
      type: "Feature",
      properties: {},
      geometry: {
        type: "LineString",
        coordinates: coords
      }
    };

    // 5) Crear mapa centrado en el primer punto
    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/streets-v12',
      center: coords[0],
      zoom: 14
    });

    map.on("load", () => {

      // --- Línea de ruta ---
      map.addSource("route", { type: "geojson", data: routeLine });

      map.addLayer({
        id: "route-line",
        type: "line",
        source: "route",
        layout: { "line-join": "round", "line-cap": "round" },
        paint: {
          "line-width": 4,
          "line-color": "#1E88E5"
        }
      });

      // --- Puntos ---
      map.addSource("stops", { type: "geojson", data: geo });

      map.addLayer({
        id: "stops-circle",
        type: "circle",
        source: "stops",
        paint: {
          "circle-radius": 5,
          "circle-color": "#FF5722",
          "circle-stroke-width": 1,
          "circle-stroke-color": "#ffffff"
        }
      });

      // --- Ajustar vista ---
      const bounds = new mapboxgl.LngLatBounds();
      coords.forEach(c => bounds.extend(c));
      map.fitBounds(bounds, { padding: 40 });

      // --- Panel con clientes ---
      const clientes = puntos.map(p => p.properties.cliente);

      panel.innerHTML =
        `<h3>Clientes ${bk}</h3>` +
        clientes.map((c, i) =>
          `<div class="cliente-item"><b>${i+1}.</b> ${c}</div>`
        ).join("");
    });
  }

  loadRouteAndDraw();
</script>
</body>
</html>
