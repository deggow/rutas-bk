<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Navegaci√≥n OSRM + MapLibre</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <!-- MapLibre GL JS -->
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
    }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }
    #panel {
      position: absolute;
      top: 10px;
      left: 10px;
      max-width: 320px;
      max-height: 85%;
      overflow-y: auto;
      background: rgba(255,255,255,0.95);
      padding: 10px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
      font-size: 12px;
    }
    #panel h3 {
      margin-top: 0;
      font-size: 14px;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <div id="panel"><em>Cargando ruta...</em></div>

<script>
async function loadRouteAndDraw() {
  // Obtener BK desde la URL
  const params = new URLSearchParams(window.location.search);
  const bk = params.get("bk") || "BK4802";

  // 1) Cargar GeoJSON
  const geo = await fetch(`public/${bk}.geojson`).then(r => r.json());

  // 2) Ordenar puntos por seq
  const sorted = geo.features.slice().sort((a, b) => a.properties.seq - b.properties.seq);
  const coords = sorted.map(f => f.geometry.coordinates);

  // 3) Construir string OSRM lon,lat;lon,lat;...
  const coordString = coords.map(c => c.join(",")).join(";");

  // 4) Llamar a OSRM Directions (GRATIS, sin token)
  const url = `https://router.project-osrm.org/route/v1/driving/${coordString}?overview=full&geometries=geojson&steps=true`;
  const data = await fetch(url).then(r => r.json());

  if (!data.routes || !data.routes.length) {
    document.getElementById("panel").innerHTML = "<b>Error:</b> No se pudo generar la ruta.";
    console.error("OSRM response:", data);
    return;
  }

  const route = data.routes[0];
  const routeGeom = route.geometry;

  // 5) Crear mapa con MapLibre
  const map = new maplibregl.Map({
    container: "map",
    style: "https://demotiles.maplibre.org/style.json",
    center: coords[0],
    zoom: 15
  });

  map.on("load", () => {
    // 6) Dibujar ruta OSRM
    map.addSource("route", {
      type: "geojson",
      data: {
        type: "Feature",
        geometry: routeGeom
      }
    });

    map.addLayer({
      id: "route-line",
      type: "line",
      source: "route",
      paint: {
        "line-width": 6,
        "line-color": "#007AFF"
      }
    });

    // 7) Dibujar puntos
    map.addSource("stops", { type: "geojson", data: geo });

    map.addLayer({
      id: "stops-circle",
      type: "circle",
      source: "stops",
      paint: {
        "circle-radius": 4,
        "circle-color": "#FF5722",
        "circle-stroke-width": 1,
        "circle-stroke-color": "#ffffff"
      }
    });

    // 8) Ajustar a la ruta completa
    const bounds = new maplibregl.LngLatBounds();
    routeGeom.coordinates.forEach(c => bounds.extend(c));
    map.fitBounds(bounds, { padding: 40 });

    // 9) Construir turn-by-turn
    const panel = document.getElementById("panel");
    const steps = [];
    route.legs.forEach(leg => leg.steps.forEach(s => steps.push(s)));

    panel.innerHTML =
      `<h3>Indicaciones ${bk}</h3>` +
      steps.map((s, i) => `<div>${i + 1}. ${s.maneuver.instruction}</div>`).join("");
  });
}

loadRouteAndDraw();
</script>
</body>
</html>