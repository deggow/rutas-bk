<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Ruta del Camión</title>
  <style>
    html, body {
      margin: 0;
      height: 100%;
      font-family: system-ui, sans-serif;
    }
    #map {
      position: absolute;
      top: 0; bottom: 0; right: 0; left: 320px;
    }
    #panel {
      position: absolute;
      top: 0; left: 0;
      width: 320px;
      bottom: 0;
      overflow-y: auto;
      background: #fff;
      padding: 12px;
      box-shadow: 2px 0 8px rgba(0,0,0,0.2);
      z-index: 10;
      font-size: 13px;
    }
    #panel h3 {
      margin: 0 0 8px 0;
      font-size: 15px;
    }
    .cliente {
      padding: 6px 4px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .cliente:hover {
      background: #f5f5f5;
    }
  </style>
</head>

<body>
  <div id="panel"><em>Cargando clientes...</em></div>
  <div id="map"></div>

  <script>
    async function init() {
      try {
        const params = new URLSearchParams(window.location.search);
        const bk = params.get("bk") || "BK4802";

        // 1) Cargar GeoJSON local
        const resp = await fetch(`public/${bk}.geojson`);
        if (!resp.ok) {
          document.getElementById("panel").innerHTML =
            "<b>Error:</b> No se pudo cargar el GeoJSON.";
          console.error("Error cargando GeoJSON:", resp.status, resp.statusText);
          return;
        }

        const geo = await resp.json();

        // 2) Ordenar por seq
        const sorted = geo.features
          .slice()
          .sort((a, b) => a.properties.seq - b.properties.seq);

        if (!sorted.length) {
          document.getElementById("panel").innerHTML =
            "<b>Error:</b> No hay puntos en esta ruta.";
          return;
        }

        const coords = sorted.map(f => ({
          lng: f.geometry.coordinates[0],
          lat: f.geometry.coordinates[1]
        }));

        // 3) Crear mapa de Google centrado en el primer punto
        const map = new google.maps.Map(document.getElementById("map"), {
          zoom: 14,
          center: coords[0],
          // mapId: "TU_MAP_ID_OPCIONAL"
        });

        // 4) Marcadores numerados
        const markers = [];
        sorted.forEach((f, i) => {
          const pos = {
            lat: f.geometry.coordinates[1],
            lng: f.geometry.coordinates[0]
          };
          const marker = new google.maps.Marker({
            position: pos,
            map,
            label: String(i + 1)
          });
          markers.push(marker);
        });

        // 5) Pedir la ruta a OSRM (sin límite de waypoints de Google)
        let polyline = null;
        if (coords.length >= 2) {
          const coordString = coords
            .map(c => `${c.lng},${c.lat}`)
            .join(";");

          const osrmUrl =
            `https://router.project-osrm.org/route/v1/driving/${coordString}` +
            `?overview=full&geometries=geojson&steps=false`;

          const osrmResp = await fetch(osrmUrl);
          const osrmData = await osrmResp.json();

          if (
            osrmData.code === "Ok" &&
            osrmData.routes &&
            osrmData.routes.length
          ) {
            const routeGeom = osrmData.routes[0].geometry;

            const path = routeGeom.coordinates.map(([lng, lat]) => ({
              lat,
              lng
            }));

            polyline = new google.maps.Polyline({
              path,
              map,
              strokeColor: "#007AFF",
              strokeOpacity: 1.0,
              strokeWeight: 5
            });

            // Ajustar vista a la ruta completa
            const bounds = new google.maps.LatLngBounds();
            path.forEach(p => bounds.extend(p));
            map.fitBounds(bounds, { padding: 50 });
          } else {
            console.error("Respuesta OSRM inválida:", osrmData);
          }
        }

        // 6) Panel izquierdo con lista de clientes en secuencia
        const panel = document.getElementById("panel");
        panel.innerHTML =
          `<h3>Clientes ${bk}</h3>` +
          sorted
            .map((f, i) => {
              const nombre =
                f.properties.cliente || "(cliente sin nombre)";
              return `<div class="cliente" data-index="${i}">
                        <b>${i + 1}.</b> ${nombre}
                      </div>`;
            })
            .join("");

        // 7) Click en un cliente -> centra el mapa en su marcador
        panel.addEventListener("click", (e) => {
          const item = e.target.closest(".cliente");
          if (!item) return;
          const idx = Number(item.dataset.index);
          const marker = markers[idx];
          if (!marker) return;

          map.panTo(marker.getPosition());
          map.setZoom(17);
        });
      } catch (err) {
        console.error(err);
        document.getElementById("panel").innerHTML =
          "<b>Error inesperado:</b> revisa la consola.";
      }
    }

    // Para que el callback de Google Maps encuentre la función
    window.init = init;
  </script>

  <!-- Sustituye YOUR_GOOGLE_MAPS_API_KEY por tu key real -->
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCkDF9OBntDCALLQsi4McjampEMebMBQkc&callback=init"
    async
    defer
  ></script>
</body>
</html>
